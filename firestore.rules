rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Allow reads of all books and chapters (public content)
    // Writes are allowed for everyone - app-level device whitelist checks enforce security
    // Email authentication is only used to whitelist devices, not for ongoing access
    match /books/{bookId}/chapters/{chapterId} {
      allow read: if true;
      // Allow writes - app verifies device is whitelisted before allowing editor access
      allow create: if true;
      allow update: if true;
      allow delete: if true;
    }
    
    match /books/{bookId}/chapters/{chapterId}/subchapters/{subchapterId} {
      allow read: if true;
      // Allow writes - app verifies device is whitelisted before allowing editor access
      allow create: if true;
      allow update: if true;
      allow delete: if true;
    }
    
    // Allowed emails: Tracks which emails can whitelist devices
    // Only allow reads for clients, writes must be done via Firebase Console or Admin SDK
    match /allowedEmails/{email} {
      allow read: if true; // Anyone can check if an email is allowed
      allow write: if false; // NO client-side writes - only via Firebase Console or Admin SDK
    }
    
    // Editor whitelist: Device UUIDs with editor access
    // Authenticated users can write their device ID if their email is allowed
    match /editorWhitelist/{deviceId} {
      allow read: if true; // Anyone can check if a device is whitelisted
      allow write: if request.auth != null; // Only authenticated users can write
    }
  }
}

